# imgbase パフォーマンスベースライン

**測定日:** 2025-10-05
**測定環境:** 本番環境 (Cloudflare Workers)
**測定対象:** https://imgbase-worker.belong2jazz.workers.dev

## テスト条件

- **画像ID:** 10920e1e-631e-4831-bf33-cf5bb19af55a
- **テストファイル:** sample.jpg (51,224 bytes)
- **測定回数:** 5回 (ウォームアップ: 2回)
- **測定ツール:** scripts/benchmark.mjs

## ベンチマーク結果

### レスポンスタイム

| バリエーション       | サイズ(KB) | 平均(ms) | 中央値(ms) | p95(ms) | 最小(ms) | 最大(ms) |
|---------------------|-----------|---------|-----------|---------|---------|---------|
| Large JPEG (1200x675)  | 50.0 | 201.39 | 195.44 | 223.09 | 190.84 | 223.09 |
| Medium JPEG (800x450)  | 50.0 | 273.51 | 251.55 | 411.32 | 205.83 | 411.32 |
| Small JPEG (400x225)   | 50.0 | 212.77 | 199.14 | 280.55 | 183.19 | 280.55 |
| Medium WebP (800x450)  | 50.0 | 270.77 | 257.82 | 392.96 | 209.23 | 392.96 |
| Small WebP (400x225)   | 50.0 | 251.04 | 272.77 | 295.91 | 195.42 | 295.91 |

**平均レスポンスタイム:** 241.90 ms
**平均p95:** 320.77 ms

## 統合テスト結果

**実施日時:** 2025-10-05
**スクリプト:** scripts/integration-test.mjs

### テスト結果サマリ
- ✅ **成功:** 10/10
- ❌ **失敗:** 0/10
- **成功率:** 100%

### テスト項目
1. ✅ ファイル読み込み (sample.jpg, 51,224 bytes)
2. ✅ 署名付きURL取得
3. ✅ R2へのアップロード
4. ✅ アップロード完了通知
5. ✅ 画像一覧APIでメタデータ確認 (status: stored)
6. ✅ 画像配信テスト (1200x675.jpg)
7. ✅ バリエーション配信 (800x450.jpg)
8. ✅ バリエーション配信 (400x225.webp)
9. ✅ エラーハンドリング (存在しない画像で404)
10. ✅ 認証テスト (認証なしで401)

### アップロードフロー
- **署名付きURL生成:** 成功
- **R2アップロード:** 成功
- **ハッシュ値:** 86af7f7e7efe3533dc82be2a942e9820e65e9dcc26cb8b1e8bc9d126d6e4749a
- **D1メタデータ登録:** 成功 (status: stored)

## インフラ状態

### R2 ストレージ
- **バケット名:** imgbase
- **テストオブジェクト数:** 5+ (オリジナル + 派生サイズ)
- **オブジェクトキー例:**
  - `10920e1e-631e-4831-bf33-cf5bb19af55a/original/sample.jpg`
  - `10920e1e-631e-4831-bf33-cf5bb19af55a/1200x675.jpg`
  - `10920e1e-631e-4831-bf33-cf5bb19af55a/800x450.jpg`
  - 他

### D1 データベース
- **データベース名:** imgbase-db
- **テーブル:** images, albums, tags, image_tags
- **テストレコード:** 複数の画像メタデータ登録済み

### Worker
- **デプロイ状況:** 最新版デプロイ済み
- **環境変数:** 設定済み
- **シークレット:** Basic認証情報設定済み

## パフォーマンス評価

### ✅ 良好な点
1. **レスポンスタイム:** 平均241ms、すべてのバリエーションで500ms未満
2. **統合テスト:** 100%成功
3. **エラーハンドリング:** 適切に404/401を返却
4. **データ整合性:** D1とR2が正しく連携

### ⚠️ 改善の余地
1. **画像リサイズ:** 現在はオリジナルをそのまま返却（Image Resizingは未実装）
   - すべてのサイズで50.02 KBと同一 → 実際のリサイズが必要
2. **キャッシュヒット率:** Cloudflare CDNを経由していないため測定不可
   - DNS統合後に再測定が必要
3. **レスポンスタイムのばらつき:** p95が平均の1.3-1.5倍
   - コールドスタートまたはR2レイテンシの影響の可能性

## コスト試算（初期）

### R2 ストレージ
- **想定:** 10,000画像 × 5MB = 50GB
- **コスト:** 50GB × $0.015 = **$0.75/月**

### Worker リクエスト
- **想定:** 100,000リクエスト/月
- **コスト:** 100,000 × $0.30/1M = **$0.03/月**

### 合計
- **月額:** 約 **$0.78**
- **年額:** 約 **$9.36**

## 次のアクション

1. ✅ 統合テスト完了
2. ✅ 性能ベースライン記録
3. ⏳ Cloudflare Image Resizing 実装
4. ⏳ DNS統合後のCDNキャッシュ測定
5. ⏳ 本番トラフィックでの継続監視

## 参考ドキュメント

- [統合テスト手順書](./integration-test.md)
- [性能測定ガイド](./performance-testing.md)
- [運用ガイド](./operations.md)
- [リリースチェックリスト](./release-checklist.md)
