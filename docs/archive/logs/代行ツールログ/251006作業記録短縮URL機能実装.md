 📋 作業記録: 短縮URL機能実装（Phase 1: バックエンド）

  実施日: 2025-10-06所要時間: 約2時間ステータス: ✅ 完了・本番稼働中

  ---
  実装内容

  1. D1データベース拡張

  マイグレーションファイル: db/migrations/0002_add_short_id.sql

  -- Add short_id column without UNIQUE constraint first
  ALTER TABLE images ADD COLUMN short_id TEXT;

  -- Create unique index (allows NULL values)
  CREATE UNIQUE INDEX idx_images_short_id ON images(short_id) WHERE short_id IS NOT
  NULL;

  実行結果:
  - ローカルDB: ✅ 適用完了
  - 本番DB: ✅ 適用完了（3コマンド、4.21ms）

  ---
  2. Worker API 実装

  変更ファイル: worker/src/index.ts

  2-1. short_id生成ヘルパー関数

  function generateShortId(): string {
    const chars = "abcdefghijklmnopqrstuvwxyz0123456789";
    let result = "";
    for (let i = 0; i < 8; i++) {
      result += chars[Math.floor(Math.random() * chars.length)];
    }
    return result;
  }

  async function generateUniqueShortId(db: D1Database): Promise<string> {
    for (let attempt = 0; attempt < 10; attempt++) {
      const shortId = generateShortId();
      const exists = await db
        .prepare("SELECT 1 FROM images WHERE short_id = ?1")
        .bind(shortId)
        .first();

      if (!exists) {
        return shortId;
      }
    }
    throw new Error("Failed to generate unique short_id after 10 attempts");
  }

  2-2. 短縮URL配信エンドポイント

  // GET /:shortId
  router.get("/:shortId", async (request, env: Env) => {
    const { shortId } = request.params ?? {};

    // Validate short_id format (8 characters, lowercase alphanumeric)
    if (!shortId || !/^[a-z0-9]{8}$/.test(shortId)) {
      return new Response("Not found", { status: 404 });
    }

    await ensureSchema(env);

    const record = await env.IMGBASE_DB.prepare(
      "SELECT bucket_key FROM images WHERE short_id = ?1"
    ).bind(shortId).first<{ bucket_key: string }>();

    if (!record) {
      return new Response("Image not found", { status: 404 });
    }

    const object = await env.IMGBASE_BUCKET.get(record.bucket_key);
    if (!object) {
      return new Response("R2 object not found", { status: 404 });
    }

    return new Response(object.body, {
      headers: {
        "content-type": object.httpMetadata?.contentType || "application/octet-stream",
        "cache-control": "public, max-age=31536000, immutable"
      }
    });
  });

  2-3. アップロード時のshort_id自動生成

  修正箇所: POST /upload/proxy

  // Generate unique short_id
  const shortId = await generateUniqueShortId(env.IMGBASE_DB);

  // Insert metadata with short_id
  await env.IMGBASE_DB.prepare(
    `INSERT INTO images (id, bucket_key, original_filename, mime, bytes, status,
  hash_sha256, short_id, created_at, updated_at)
     VALUES (?1, ?2, ?3, ?4, ?5, ?6, ?7, ?8, ?9, ?10)`
  )
    .bind(imageId, objectKey, fileName, contentType, fileSize, "stored", hash, shortId,
  now, now)
    .run();

  // Return short_id in response
  return Response.json({
    imageId,
    objectKey,
    bytes: fileSize,
    hash,
    shortId,  // ← 追加
    status: "stored"
  });

  2-4. /images API拡張

  変更: SELECT文に short_id を追加

  let query =
    "SELECT id, original_filename, mime, bytes, status, hash_sha256, short_id,
  created_at, updated_at FROM images";

  ---
  3. 既存画像へのshort_id付与

  実行スクリプト: worker/scripts/generate-short-ids-for-existing.sql

  対象画像: 9件

  | ID           | ファイル名                          | short_id |
  |--------------|--------------------------------|----------|
  | e9441efb-... | sample.jpg                     | a1b2c3d4 |
  | 87110f9a-... | sample.jpg                     | e5f6g7h8 |
  | 10920e1e-... | sample.jpg                     | i9j0k1l2 |
  | 21aa0fdb-... | sample.jpg                     | m3n4o5p6 |
  | 5b5836e6-... | sample.jpg                     | q7r8s9t0 |
  | b4ba44ea-... | sample.jpg                     | u1v2w3x4 |
  | c54d0c76-... | PXL_20250623_011922083.jpg     | y5z6a7b8 |
  | 44983f30-... | PXL_20250623_011924136.jpg     | c9d0e1f2 |
  | ee572c66-... | PXL_20250623_011930134[1].webp | g3h4i5j6 |

  実行結果:
  - 9 queries executed
  - 9 rows read, 18 rows written
  - Database size: 0.08 MB

  ---
  4. デプロイ

  Worker Version ID: 2fdcb5ba-8323-477f-be7b-6320a5699909Bundle Size: 19.52 KiB / gzip:
  5.91 KiBデプロイ時刻: 2025-10-06 13:56 JST

  ---
  動作確認

  テスト実行

  # 短縮URL配信テスト
  $ curl -I https://imgbase-worker.belong2jazz.workers.dev/c9d0e1f2

  HTTP/2 200
  content-type: image/jpeg
  content-length: 6209535
  cache-control: public, max-age=31536000, immutable

  ✅ 成功: 画像が正常に配信されている

  実際に動作する短縮URL

  https://imgbase-worker.belong2jazz.workers.dev/c9d0e1f2
  https://imgbase-worker.belong2jazz.workers.dev/y5z6a7b8
  https://imgbase-worker.belong2jazz.workers.dev/g3h4i5j6

  ---
  Git履歴

  Commit 1: 72d428f
  Simplify Worker API: disable variant generation
  - Disable /i/:uid/:size endpoint (returns 410 Gone)
  - Remove resizeImage(), generateVariantResponse(), normalizeFormat()

  Commit 2: d76ca1e
  Add short URL feature (Phase 1: Backend)
  - Add short_id column to images table (8-char alphanumeric)
  - Implement GET /:shortId endpoint for short URL delivery
  - Auto-generate unique short_id on upload
  - Populate short_ids for 9 existing images

  ---
  技術仕様

  | 項目        | 仕様                              |
  |-----------|---------------------------------|
  | URL形式     | https://img.be2nd.com/{shortId} |
  | short_id長 | 8文字                             |
  | 文字種       | [a-z0-9]                        |
  | 重複防止      | D1 UNIQUE INDEX                 |
  | 生成タイミング   | アップロード完了時                       |
  | キャッシュ     | max-age=31536000, immutable     |

  ---
  残課題

  1. カスタムドメイン設定
    - img.be2nd.com を Worker にルーティング
    - Cloudflare Dashboard で設定（手動）
  2. 管理画面UI実装（次フェーズ）
    - URL列表示
    - コピーボタン
    - ソート機能
    - 日付フィルタ
    - ギャラリー表示