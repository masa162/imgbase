 ğŸ“‹ ä½œæ¥­è¨˜éŒ²: çŸ­ç¸®URLæ©Ÿèƒ½å®Ÿè£…ï¼ˆPhase 1: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼‰

  å®Ÿæ–½æ—¥: 2025-10-06æ‰€è¦æ™‚é–“: ç´„2æ™‚é–“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âœ… å®Œäº†ãƒ»æœ¬ç•ªç¨¼åƒä¸­

  ---
  å®Ÿè£…å†…å®¹

  1. D1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ‹¡å¼µ

  ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«: db/migrations/0002_add_short_id.sql

  -- Add short_id column without UNIQUE constraint first
  ALTER TABLE images ADD COLUMN short_id TEXT;

  -- Create unique index (allows NULL values)
  CREATE UNIQUE INDEX idx_images_short_id ON images(short_id) WHERE short_id IS NOT
  NULL;

  å®Ÿè¡Œçµæœ:
  - ãƒ­ãƒ¼ã‚«ãƒ«DB: âœ… é©ç”¨å®Œäº†
  - æœ¬ç•ªDB: âœ… é©ç”¨å®Œäº†ï¼ˆ3ã‚³ãƒãƒ³ãƒ‰ã€4.21msï¼‰

  ---
  2. Worker API å®Ÿè£…

  å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«: worker/src/index.ts

  2-1. short_idç”Ÿæˆãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°

  function generateShortId(): string {
    const chars = "abcdefghijklmnopqrstuvwxyz0123456789";
    let result = "";
    for (let i = 0; i < 8; i++) {
      result += chars[Math.floor(Math.random() * chars.length)];
    }
    return result;
  }

  async function generateUniqueShortId(db: D1Database): Promise<string> {
    for (let attempt = 0; attempt < 10; attempt++) {
      const shortId = generateShortId();
      const exists = await db
        .prepare("SELECT 1 FROM images WHERE short_id = ?1")
        .bind(shortId)
        .first();

      if (!exists) {
        return shortId;
      }
    }
    throw new Error("Failed to generate unique short_id after 10 attempts");
  }

  2-2. çŸ­ç¸®URLé…ä¿¡ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

  // GET /:shortId
  router.get("/:shortId", async (request, env: Env) => {
    const { shortId } = request.params ?? {};

    // Validate short_id format (8 characters, lowercase alphanumeric)
    if (!shortId || !/^[a-z0-9]{8}$/.test(shortId)) {
      return new Response("Not found", { status: 404 });
    }

    await ensureSchema(env);

    const record = await env.IMGBASE_DB.prepare(
      "SELECT bucket_key FROM images WHERE short_id = ?1"
    ).bind(shortId).first<{ bucket_key: string }>();

    if (!record) {
      return new Response("Image not found", { status: 404 });
    }

    const object = await env.IMGBASE_BUCKET.get(record.bucket_key);
    if (!object) {
      return new Response("R2 object not found", { status: 404 });
    }

    return new Response(object.body, {
      headers: {
        "content-type": object.httpMetadata?.contentType || "application/octet-stream",
        "cache-control": "public, max-age=31536000, immutable"
      }
    });
  });

  2-3. ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã®short_idè‡ªå‹•ç”Ÿæˆ

  ä¿®æ­£ç®‡æ‰€: POST /upload/proxy

  // Generate unique short_id
  const shortId = await generateUniqueShortId(env.IMGBASE_DB);

  // Insert metadata with short_id
  await env.IMGBASE_DB.prepare(
    `INSERT INTO images (id, bucket_key, original_filename, mime, bytes, status,
  hash_sha256, short_id, created_at, updated_at)
     VALUES (?1, ?2, ?3, ?4, ?5, ?6, ?7, ?8, ?9, ?10)`
  )
    .bind(imageId, objectKey, fileName, contentType, fileSize, "stored", hash, shortId,
  now, now)
    .run();

  // Return short_id in response
  return Response.json({
    imageId,
    objectKey,
    bytes: fileSize,
    hash,
    shortId,  // â† è¿½åŠ 
    status: "stored"
  });

  2-4. /images APIæ‹¡å¼µ

  å¤‰æ›´: SELECTæ–‡ã« short_id ã‚’è¿½åŠ 

  let query =
    "SELECT id, original_filename, mime, bytes, status, hash_sha256, short_id,
  created_at, updated_at FROM images";

  ---
  3. æ—¢å­˜ç”»åƒã¸ã®short_idä»˜ä¸

  å®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ: worker/scripts/generate-short-ids-for-existing.sql

  å¯¾è±¡ç”»åƒ: 9ä»¶

  | ID           | ãƒ•ã‚¡ã‚¤ãƒ«å                          | short_id |
  |--------------|--------------------------------|----------|
  | e9441efb-... | sample.jpg                     | a1b2c3d4 |
  | 87110f9a-... | sample.jpg                     | e5f6g7h8 |
  | 10920e1e-... | sample.jpg                     | i9j0k1l2 |
  | 21aa0fdb-... | sample.jpg                     | m3n4o5p6 |
  | 5b5836e6-... | sample.jpg                     | q7r8s9t0 |
  | b4ba44ea-... | sample.jpg                     | u1v2w3x4 |
  | c54d0c76-... | PXL_20250623_011922083.jpg     | y5z6a7b8 |
  | 44983f30-... | PXL_20250623_011924136.jpg     | c9d0e1f2 |
  | ee572c66-... | PXL_20250623_011930134[1].webp | g3h4i5j6 |

  å®Ÿè¡Œçµæœ:
  - 9 queries executed
  - 9 rows read, 18 rows written
  - Database size: 0.08 MB

  ---
  4. ãƒ‡ãƒ—ãƒ­ã‚¤

  Worker Version ID: 2fdcb5ba-8323-477f-be7b-6320a5699909Bundle Size: 19.52 KiB / gzip:
  5.91 KiBãƒ‡ãƒ—ãƒ­ã‚¤æ™‚åˆ»: 2025-10-06 13:56 JST

  ---
  å‹•ä½œç¢ºèª

  ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

  # çŸ­ç¸®URLé…ä¿¡ãƒ†ã‚¹ãƒˆ
  $ curl -I https://imgbase-worker.belong2jazz.workers.dev/c9d0e1f2

  HTTP/2 200
  content-type: image/jpeg
  content-length: 6209535
  cache-control: public, max-age=31536000, immutable

  âœ… æˆåŠŸ: ç”»åƒãŒæ­£å¸¸ã«é…ä¿¡ã•ã‚Œã¦ã„ã‚‹

  å®Ÿéš›ã«å‹•ä½œã™ã‚‹çŸ­ç¸®URL

  https://imgbase-worker.belong2jazz.workers.dev/c9d0e1f2
  https://imgbase-worker.belong2jazz.workers.dev/y5z6a7b8
  https://imgbase-worker.belong2jazz.workers.dev/g3h4i5j6

  ---
  Gitå±¥æ­´

  Commit 1: 72d428f
  Simplify Worker API: disable variant generation
  - Disable /i/:uid/:size endpoint (returns 410 Gone)
  - Remove resizeImage(), generateVariantResponse(), normalizeFormat()

  Commit 2: d76ca1e
  Add short URL feature (Phase 1: Backend)
  - Add short_id column to images table (8-char alphanumeric)
  - Implement GET /:shortId endpoint for short URL delivery
  - Auto-generate unique short_id on upload
  - Populate short_ids for 9 existing images

  ---
  æŠ€è¡“ä»•æ§˜

  | é …ç›®        | ä»•æ§˜                              |
  |-----------|---------------------------------|
  | URLå½¢å¼     | https://img.be2nd.com/{shortId} |
  | short_idé•· | 8æ–‡å­—                             |
  | æ–‡å­—ç¨®       | [a-z0-9]                        |
  | é‡è¤‡é˜²æ­¢      | D1 UNIQUE INDEX                 |
  | ç”Ÿæˆã‚¿ã‚¤ãƒŸãƒ³ã‚°   | ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†æ™‚                       |
  | ã‚­ãƒ£ãƒƒã‚·ãƒ¥     | max-age=31536000, immutable     |

  ---
  æ®‹èª²é¡Œ

  1. ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®š
    - img.be2nd.com ã‚’ Worker ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
    - Cloudflare Dashboard ã§è¨­å®šï¼ˆæ‰‹å‹•ï¼‰
  2. ç®¡ç†ç”»é¢UIå®Ÿè£…ï¼ˆæ¬¡ãƒ•ã‚§ãƒ¼ã‚ºï¼‰
    - URLåˆ—è¡¨ç¤º
    - ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³
    - ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½
    - æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿
    - ã‚®ãƒ£ãƒ©ãƒªãƒ¼è¡¨ç¤º