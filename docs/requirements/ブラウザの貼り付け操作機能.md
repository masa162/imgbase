# imgbase ローカル画像変換機能 追加要件書（クリップボード貼り付け対応）

**作成日**: 2025-10-06  
**バージョン**: 0.1  
**ステータス**: 草案  

---

## 1. 概要

### 1.1 目的

ブラウザの貼り付け操作（Ctrl+V / Command+V など）で端末クリップボード内の画像をローカル変換ツールに追加できるようにし、既存のアップロード手段（ドラッグ＆ドロップ／ファイル選択）と併用しつつ操作性を向上させる。

### 1.2 対象範囲

- 対象画面: `/converter`
- 対象利用者: PCブラウザ（Chrome / Edge / Safari 最新版）の管理画面利用者
- 対象データ: クリップボードに格納された画像（PNG / JPEG(JPG) / WebP / GIF）
- 非対象: テキスト・URL・ファイルパスなど画像以外のデータ、モバイル端末のブラウザ

---

## 2. 機能要件

### 2.1 入力

| 項目       | 仕様                                                                                  |
|------------|---------------------------------------------------------------------------------------|
| 操作       | ブラウザ上で Ctrl+V / Command+V などの貼り付け操作                                    |
| 対応形式   | PNG, JPEG(JPG), WebP, GIF                                                             |
| 同時処理   | クリップボードに複数画像が含まれている場合は逐次追加（各ブロブごと）                |
| 大きさ制限 | 既存仕様と同様（ブラウザメモリ依存、個別最大サイズ制限なし）                        |

### 2.2 挙動

1. ユーザーが `/converter` ページで貼り付けを実行すると `paste` イベントを捕捉。
2. `event.clipboardData.items` もしくは `files` から画像 `Blob` を抽出。
3. 対応形式の場合は `File` オブジェクトへ変換し、既存の変換キューへ即追加。
4. 追加された画像は自動で変換処理が走り、既存のプレビューや ZIP ダウンロード機能と同様に扱われる。

### 2.3 非対応／無反応条件

| ケース           | 挙動                       |
|------------------|----------------------------|
| 画像以外のデータ | 何も起こらない（通知なし） |
| 対応外ブラウザ   | `paste` イベントが発火しないため、何も起こらない |

### 2.4 エラー

- ブラウザ API が画像 `Blob` を取得できなかった場合は既存の変換失敗メッセージを使用。
- クリップボードから取得した画像が破損している場合も既存処理に委譲。

---

## 3. UI 要件

### 3.1 表示

| 要素       | 仕様                                                                                       |
|------------|--------------------------------------------------------------------------------------------|
| 補助テキスト | ドロップゾーン付近に「クリップボード画像の貼り付け(Ctrl+V)にも対応」の文言を追加         |
| 状態表示   | 貼り付け専用の UI は追加せず、既存の進捗／成功／失敗表示を流用                           |

### 3.2 操作感

- 貼り付け後すぐに変換結果リストへ追加される。
- キーボード操作主体のユーザーでもファイル選択を経ずに変換できることを明示。

---

## 4. 技術仕様

### 4.1 実装ポイント

| 項目             | 詳細                                                                           |
|------------------|--------------------------------------------------------------------------------|
| イベント         | `/converter` 表示中に `window` またはルート要素へ `paste` リスナーを追加       |
| 取得 API         | `event.clipboardData.files` もしくは `items` から `File` / `Blob` を抽出       |
| フィルタ         | MIME タイプが `image/` で始まるもののみ許可                                   |
| 変換キュー連携   | 既存の `handleFilesSelected` へ `File[]` を渡して再利用                        |
| フォーカス条件   | `/converter` 表示時のみ受け付け、他ページではリスナーを解除                   |
| クリップボード権限 | 貼り付けはユーザー操作起点のため追加許可は不要                                |

### 4.2 テストケース（抜粋）

| ケース          | 手順                                                       | 期待結果                                         |
|-----------------|------------------------------------------------------------|--------------------------------------------------|
| PNG を貼り付け  | エディタ等で PNG をコピー → `/converter` で貼り付け        | キューへ追加され WebP 変換が完了                |
| JPEG を貼り付け | ブラウザで JPEG をコピー → 貼り付け                         | 同上                                             |
| WebP を貼り付け | WebP 画像をコピー → 貼り付け                               | 同上                                             |
| GIF を貼り付け  | アニメ GIF をコピー → 貼り付け                              | 静止画として WebP 変換（現行仕様に準拠）        |
| テキストを貼付  | 文字列をコピー → 貼り付け                                   | 無反応                                           |
| 複数画像        | 複数画像をまとめてコピー → 貼り付け                         | 全て順次キューへ追加                             |
| Safari で動作   | Safari 最新版で PNG を貼り付け                              | 同上                                             |
| 他ページで貼付  | `/converter` 以外のページで貼り付け                         | リスナー未登録のため無反応                      |

---

## 5. 非機能要件

| 項目             | 目標                                                 |
|------------------|------------------------------------------------------|
| パフォーマンス   | 貼り付けによるオーバーヘッドは数 ms 程度（従来同等） |
| セキュリティ     | クリップボード内容はユーザー操作時のみ取得           |
| アクセシビリティ | キーボード主体のユーザーにも利用可能である旨を明記   |

---

## 6. 追加検討事項

- 貼り付け完了時の通知（トースト等）を追加するかどうか。
- 大容量画像を連続貼り付けした際のメモリ負荷対策（既存キュー制御で十分か要確認）。
- 将来モバイル対応が必要になった場合の調査。

---

必要があれば、さらに詳細を追加・更新しますのでお知らせください。
