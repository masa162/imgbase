# imgbase 画像リサイズ機能 要件定義書

**作成日**: 2025-10-06
**バージョン**: 1.0
**ステータス**: 承認済み

---

## 1. 概要

### 1.1 目的

PNG/JPEG画像を自動的にWebP形式に変換し、Web表示に最適なサイズ（長辺500px）にリサイズして保存する機能を実装する。ストレージコストを最小化しつつ、高いQoL（Quality of Life）を実現する。

### 1.2 背景

- **課題1**: 大容量の元画像（6MB+）がそのまま保存され、ストレージを圧迫
- **課題2**: リサイズ機能がスタブ実装で、バリアントも元サイズのまま保存
- **課題3**: Web表示用に最適化された画像が欲しい（90%の利用ケース）
- **課題4**: 一部のケースではオリジナル画像も必要

### 1.3 期待される効果

- ✅ ストレージコスト削減: 6MB → 50-100KB (約98%削減)
- ✅ 転送速度向上: Web表示が高速化
- ✅ UX改善: アップロード後すぐにブログ等で利用可能
- ✅ 柔軟性: オリジナル保存モードで特殊ケースに対応

---

## 2. 機能要件

### 2.1 通常アップロード（デフォルト）

#### 入力仕様

| 項目 | 仕様 |
|------|------|
| 対応形式 | PNG, JPEG (JPG) |
| 最大サイズ | 50MB（既存制限を継承） |
| アルファチャンネル | 対応（PNG透明度を保持） |

#### 処理仕様

| 処理 | 仕様 |
|------|------|
| フォーマット変換 | PNG/JPEG → WebP |
| WebP品質 | 80-85%（バランス型） |
| リサイズロジック | 長辺を500pxに（アスペクト比保持） |
| 小画像の扱い | 500px以下は拡大しない |
| 透明度 | WebPで保持 |

**リサイズ例**:
```
入力: 4624x3472 (横長) → 出力: 500x375
入力: 3472x4624 (縦長) → 出力: 375x500
入力: 400x300 (小画像) → 出力: 400x300 (拡大しない)
```

#### 出力仕様

| 項目 | 仕様 |
|------|------|
| 保存形式 | WebPのみ |
| オリジナル画像 | **保存しない**（削除） |
| R2オブジェクトキー | `{imageId}/processed/{filename}.webp` |
| D1メタデータ | `mime="image/webp"`, `original_filename="元ファイル名"` |

### 2.2 オリジナル保存モード

#### 入力仕様

| 項目 | 仕様 |
|------|------|
| 対応形式 | すべて（PNG, JPEG, WebP, GIF, SVG等） |
| 最大サイズ | 50MB（既存制限を継承） |

#### 処理仕様

| 処理 | 仕様 |
|------|------|
| フォーマット変換 | **なし** |
| リサイズ | **なし** |
| メタデータ抽出 | あり（EXIF等） |

#### 出力仕様

| 項目 | 仕様 |
|------|------|
| 保存形式 | 元ファイルのまま |
| R2オブジェクトキー | `{imageId}/original/{filename}` |
| D1メタデータ | `mime="元のMIMEタイプ"`, `original_filename="元ファイル名"` |

---

## 3. UI/UX 要件

### 3.1 管理画面のレイアウト

**アップロードセクション**:

```
┌─────────────────────────────────────┐
│  画像アップロード                    │
├─────────────────────────────────────┤
│                                     │
│  ┌─────────────────────────────┐   │
│  │ [ファイルを選択]              │   │
│  └─────────────────────────────┘   │
│                                     │
│  ┌───────────────┐ ┌──────────────┐│
│  │通常アップロード│ │オリジナル保存││
│  │(WebP・リサイズ)│ │(無加工)      ││
│  └───────────────┘ └──────────────┘│
│                                     │
│  ※通常アップロード: PNG/JPEG→WebP  │
│    (500px・80%品質)                 │
│  ※オリジナル保存: 画像をそのまま保存│
└─────────────────────────────────────┘
```

### 3.2 ボタンの動作

#### 通常アップロードボタン
- ラベル: 「通常アップロード」
- サブテキスト: 「WebP変換・リサイズ」
- 色: プライマリ（青系）
- API: `POST /api/uploads/proxy` (既存)

#### オリジナル保存ボタン
- ラベル: 「オリジナル保存」
- サブテキスト: 「無加工」
- 色: セカンダリ（グレー系）
- API: `POST /api/uploads/original` (新規)

### 3.3 フィードバック

**成功時**:
```
✓ アップロード完了: photo.webp (45.2 KB)
  元画像: photo.jpg (6.2 MB) → WebP変換済み
```

**オリジナル保存時**:
```
✓ アップロード完了: photo.jpg (6.2 MB)
  オリジナルファイルとして保存しました
```

---

## 4. 技術要件

### 4.1 採用技術

#### 画像処理ライブラリ: sharp (WebAssembly版)

**選定理由**:
- ✅ **コスト**: 完全無料（Cloudflare Workers対応）
- ✅ **品質**: libvips ベースの高品質処理
- ✅ **機能**: WebP変換、リサイズ、透明度保持
- ✅ **パフォーマンス**: Wasm版で高速動作

**代替案との比較**:

| 方法 | コスト | 品質 | 実装難度 | 選定 |
|------|--------|------|----------|------|
| sharp-wasm | 無料 | 高 | 中 | ✅ |
| Cloudflare Image Resizing | 有料 | 最高 | 低 | ❌ |
| 外部API (Cloudinary) | 従量課金 | 高 | 低 | ❌ |

### 4.2 アーキテクチャ

#### 通常アップロード フロー

```
[ブラウザ]
  ↓ POST /api/uploads/proxy
  ↓ (File: PNG/JPEG)
[Pages Function]
  ↓ POST /upload/proxy (Basic Auth)
[Worker API]
  ├─ 1. ファイル検証
  ├─ 2. sharp-wasm でリサイズ・WebP変換
  ├─ 3. R2に保存 ({imageId}/processed/{filename}.webp)
  ├─ 4. D1にメタデータ登録
  └─ レスポンス
```

#### オリジナル保存 フロー

```
[ブラウザ]
  ↓ POST /api/uploads/original (新規)
[Pages Function]
  ↓ POST /upload/original (新規)
[Worker API]
  ├─ 1. ファイル検証
  ├─ 2. R2に保存 ({imageId}/original/{filename})
  ├─ 3. D1にメタデータ登録
  └─ レスポンス
```

### 4.3 R2オブジェクトキー構造

**変更前**:
```
{imageId}/original/{filename}
```

**変更後**:
```
{imageId}/processed/{filename}.webp  ← 通常アップロード
{imageId}/original/{filename}        ← オリジナル保存
```

### 4.4 D1スキーマ拡張

**新規カラム**:

| カラム | 型 | 説明 |
|--------|-----|------|
| `processing_mode` | TEXT | `'processed'` または `'original'` |

**既存カラムの利用**:
- `mime`: WebPの場合 `'image/webp'`
- `original_filename`: 元のファイル名を保持
- `bytes`: 処理後のファイルサイズ

---

## 5. 非機能要件

### 5.1 パフォーマンス

| 項目 | 目標値 | 測定方法 |
|------|--------|----------|
| リサイズ処理時間 | < 3秒 (6MB画像) | Worker CPU時間 |
| アップロードレスポンス | < 5秒 (6MB画像) | E2Eテスト |
| WebP変換率 | 95%以上削減 | ファイルサイズ比較 |

### 5.2 品質

| 項目 | 基準 |
|------|------|
| WebP品質 | SSIM > 0.95（元画像と比較） |
| 透明度保持 | PNG透明部分が正しく保持される |
| アスペクト比 | 元画像と同一（誤差 < 1px） |

### 5.3 コスト

| 項目 | 試算 |
|------|------|
| Worker CPU時間 | ~500ms/画像 → $0.000005/画像 |
| R2ストレージ | 6MB → 50KB → 月額 $0.00000075/画像 |
| **合計削減効果** | **98%削減** |

---

## 6. 既存データの扱い

### 6.1 既存画像（8枚）

**方針**: そのまま残す

**理由**:
- 既に保存済みの画像を遡及処理するコストが高い
- 新規アップロードから新機能を適用

### 6.2 無駄なバリアント

**削除対象**:
```
44983f30-7eea-4a58-b6c3-c13920180447/800x600.jpg    (6.21 MB)
44983f30-7eea-4a58-b6c3-c13920180447/400x300.webp   (6.21 MB)
```

**削除コマンド**:
```bash
npx wrangler r2 object delete imgbase/44983f30-7eea-4a58-b6c3-c13920180447/800x600.jpg --remote
npx wrangler r2 object delete imgbase/44983f30-7eea-4a58-b6c3-c13920180447/400x300.webp --remote
```

**実施タイミング**: 実装完了直後

---

## 7. テスト要件

### 7.1 単体テスト

| テストケース | 入力 | 期待結果 |
|-------------|------|----------|
| PNG→WebP変換 | 1000x800 PNG | 500x400 WebP (80%品質) |
| JPEG→WebP変換 | 4624x3472 JPEG | 500x375 WebP |
| 小画像処理 | 300x200 JPEG | 300x200 WebP (拡大しない) |
| 透明度保持 | PNG (透明あり) | WebP (透明保持) |
| オリジナル保存 | 任意の画像 | そのまま保存 |

### 7.2 統合テスト

| テストケース | 手順 | 期待結果 |
|-------------|------|----------|
| 通常アップロード | 6MB JPEG → 通常アップロード | R2にWebP保存、元画像なし |
| オリジナル保存 | 6MB JPEG → オリジナル保存 | R2に元画像保存 |
| D1整合性 | アップロード後 | `processing_mode` が正しい |

### 7.3 性能テスト

| テストケース | 入力サイズ | 目標時間 |
|-------------|----------|----------|
| 小画像 (100KB) | 500x500 | < 1秒 |
| 中画像 (1MB) | 2000x1500 | < 2秒 |
| 大画像 (6MB) | 4624x3472 | < 3秒 |

---

## 8. 実装スケジュール

### Phase 1: 基盤実装（1日）

- [x] 要件定義書作成
- [ ] sharp-wasm パッケージ導入
- [ ] 画像リサイズ・WebP変換関数実装
- [ ] Worker API エンドポイント修正

### Phase 2: UI実装（0.5日）

- [ ] Pages Function 新規エンドポイント作成
- [ ] 管理画面UI更新（2ボタン）
- [ ] フィードバックメッセージ実装

### Phase 3: テスト・デプロイ（0.5日）

- [ ] 単体テスト実行
- [ ] 統合テスト実行
- [ ] 無駄なバリアント削除
- [ ] 本番デプロイ

**合計所要時間**: 2日

---

## 9. リスクと対策

### リスク1: sharp-wasm のバンドルサイズ

**影響**: Worker のバンドルサイズ上限（1MB）を超える可能性

**対策**:
1. sharp-wasm の軽量版を使用
2. 必要最小限の機能のみインポート
3. バンドルサイズ監視

### リスク2: Worker CPU時間超過

**影響**: 大容量画像処理で10秒を超える可能性

**対策**:
1. 最大アップロードサイズを50MBに制限（既存）
2. タイムアウト監視
3. エラーハンドリング強化

### リスク3: WebP非対応ブラウザ

**影響**: 古いブラウザで画像が表示されない

**対策**:
- 現代のブラウザはほぼ全てWebP対応（Safari 14+, Chrome 全て）
- 必要なら fallback 機能を追加（将来）

---

## 10. 将来の拡張

### 10.1 複数サイズ対応

**要件**:
- 500px（Web表示）
- 1200px（高解像度表示）
- 100px（サムネイル）

**実装**:
- UIでサイズ選択ドロップダウン追加
- Worker API でサイズパラメータ受け取り

### 10.2 バッチ処理

**要件**:
- 既存画像の一括リサイズ
- スケジュール実行

**実装**:
- Cloudflare Queues 使用
- Workers Cron Triggers

### 10.3 AI自動最適化

**要件**:
- 画像内容に応じた品質調整
- 顔検出でクロップ位置最適化

**実装**:
- Cloudflare AI Workers 連携

---

## 11. 承認

| 役割 | 氏名 | 承認日 | 署名 |
|------|------|--------|------|
| プロダクトオーナー | User | 2025-10-06 | ✅ |
| 開発者 | Claude | 2025-10-06 | ✅ |

---

**最終更新**: 2025-10-06
**次回レビュー**: 実装完了時
